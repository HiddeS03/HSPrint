name: Build and Deploy to Supabase

on:
  push:
    branches: [ main ]
    tags:
 - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
    uses: actions/checkout@v3

    - name: Setup .NET
uses: actions/setup-dotnet@v3
      with:
 dotnet-version: '8.0.x'

    - name: Restore dependencies
    run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --no-restore --verbosity normal
 continue-on-error: true

    - name: Publish
      run: dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./artifacts

    - name: Get version
    id: version
      shell: pwsh
    run: |
        $version = Get-Content version.txt
   echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"

    - name: Create ZIP archive
      shell: pwsh
  run: |
     Compress-Archive -Path ./artifacts/* -DestinationPath HSPrint-${{ steps.version.outputs.VERSION }}.zip

- name: Upload to Supabase Storage
      shell: pwsh
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
    $version = "${{ steps.version.outputs.VERSION }}"
        $fileName = "HSPrint-$version.zip"
     $filePath = "./$fileName"
        
     $headers = @{
  "Authorization" = "Bearer $env:SUPABASE_SERVICE_ROLE_KEY"
          "Content-Type" = "application/zip"
        }
        
  $uploadUrl = "$env:SUPABASE_URL/storage/v1/object/hsprint-releases/$fileName"

 Invoke-RestMethod -Uri $uploadUrl -Method POST -Headers $headers -InFile $filePath
        
        Write-Host "Successfully uploaded $fileName to Supabase Storage"

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
   tag_name: ${{ github.ref }}
        release_name: Release ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      if: startsWith(github.ref, 'refs/tags/')
      uses: actions/upload-release-asset@v1
      env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./HSPrint-${{ steps.version.outputs.VERSION }}.zip
        asset_name: HSPrint-${{ steps.version.outputs.VERSION }}.zip
        asset_content_type: application/zip
