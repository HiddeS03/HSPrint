name: Build and Deploy to Supabase

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --no-restore --verbosity normal
      continue-on-error: true

    - name: Publish
      run: dotnet publish -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -o ./artifacts

    - name: Get version
      id: version
      shell: pwsh
      run: |
        $version = Get-Content version.txt
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"

    - name: Create ZIP archive
      shell: pwsh
      run: |
        Compress-Archive -Path ./artifacts/* -DestinationPath HSPrint-${{ steps.version.outputs.VERSION }}.zip

    - name: Upload to Supabase Storage
      shell: pwsh
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $fileName = "HSPrint-$version.zip"
        $filePath = "./$fileName"
        
        $headers = @{
          "Authorization" = "Bearer $env:SUPABASE_SERVICE_ROLE_KEY"
          "Content-Type" = "application/zip"
        }
        
        $uploadUrl = "$env:SUPABASE_URL/storage/v1/object/hsprint-releases/$fileName"

        Invoke-RestMethod -Uri $uploadUrl -Method POST -Headers $headers -InFile $filePath
        
        Write-Host "Successfully uploaded $fileName to Supabase Storage"

    - name: Create Release
      id: create_release
      if: github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: Release ${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        files: HSPrint-${{ steps.version.outputs.VERSION }}.zip
        body: |
          ## HSPrint ${{ steps.version.outputs.VERSION }}
          
          Download the latest version of HSPrint.
          
          ### Installation
          1. Download `HSPrint-${{ steps.version.outputs.VERSION }}.zip`
          2. Extract to your preferred location
          3. Run `HSPrint.exe`
          
          For more information, see the [README](https://github.com/${{ github.repository }}/blob/main/README.md)
