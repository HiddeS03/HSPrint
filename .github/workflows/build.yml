name: Build and Release HSPrint

on:
  push:
    branches: [ master, main ]
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (leave empty to auto-increment)'
        required: false
        type: string

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: Determine version
      id: version
      shell: pwsh
      run: |
        # Read current version from file
        $currentVersion = (Get-Content version.txt -Raw).Trim()
        Write-Host "Current version: $currentVersion"
        
        # Use manual version if provided, otherwise auto-increment
        if ("${{ github.event.inputs.version }}" -ne "") {
          $version = "${{ github.event.inputs.version }}"
          Write-Host "Using manual version: $version"
        } else {
          # Auto-increment patch version
          $parts = $currentVersion -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]
          $patch++
          $version = "$major.$minor.$patch"
          Write-Host "Auto-incremented version: $version"
        }
        
        # Update version.txt
        Set-Content -Path version.txt -Value $version -NoNewline
        
        # Output version for later steps
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        Write-Host "Final version: $version"

    - name: Commit version bump
      shell: pwsh
      run: |
        git config user.name "GitHub Actions"
        git config user.email "github-actions@github.com"
        git add version.txt
        
        # Only commit if there are changes
        $status = git status --porcelain
        if ($status) {
          git commit -m "chore: bump version to ${{ steps.version.outputs.VERSION }}"
          git push
          Write-Host "Version committed and pushed"
        } else {
          Write-Host "No version changes to commit"
        }

    - name: Install WiX Toolset
      shell: pwsh
      run: |
        dotnet tool install --global wix --version 4.0.5
        wix --version

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Test
      run: dotnet test --no-restore --verbosity normal
      continue-on-error: true

    - name: Publish HSPrint Service
      shell: pwsh
      run: |
        $publishDir = "bin/Release/net8.0-windows10.0.26100.0/win-x64/publish"
        dotnet publish HSPrint.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=false `
          -p:Version=${{ steps.version.outputs.VERSION }} `
          -o "./$publishDir"
  
        Write-Host "HSPrint Service publish directory contents:"
        Get-ChildItem $publishDir | Select-Object Name, Length | Select-Object -First 10

    - name: Publish Configuration Tool
      shell: pwsh
      run: |
        $configToolPublishDir = "bin/Release/net8.0-windows10.0.26100.0/win-x64/configtool"
        dotnet publish HSPrint.ConfigTool/HSPrint.ConfigTool.csproj `
          -c Release `
          -r win-x64 `
          --self-contained true `
          -p:PublishSingleFile=false `
          -p:Version=${{ steps.version.outputs.VERSION }} `
          -o "./$configToolPublishDir"
  
        Write-Host "Configuration Tool publish directory contents:"
        Get-ChildItem $configToolPublishDir | Select-Object Name, Length | Select-Object -First 10

    - name: Generate WiX file lists
      shell: pwsh
      run: |
        $publishDir = "bin/Release/net8.0-windows10.0.26100.0/win-x64/publish"
        $configToolPublishDir = "bin/Release/net8.0-windows10.0.26100.0/win-x64/configtool"
        
        Write-Host "Generating WiX file lists with proper shared file handling..."
        & ".\HSPrint.Installer\GenerateWixFiles.ps1" `
          -PublishDir $publishDir `
          -ConfigToolPublishDir $configToolPublishDir `
          -OutputDir "HSPrint.Installer"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "Failed to generate WiX file lists"
          exit 1
        }
        
        Write-Host "`nValidating generated WiX files..."
        & ".\HSPrint.Installer\ValidateWixGeneration.ps1"
        
        if ($LASTEXITCODE -ne 0) {
          Write-Error "WiX file validation failed"
          exit 1
        }

    - name: Build MSI Installer
      shell: pwsh
      run: |
        dotnet build HSPrint.Installer/HSPrint.Installer.wixproj `
          -c Release `
          -p:Version=${{ steps.version.outputs.VERSION }}
      
        # Find and copy MSI
        $msi = Get-ChildItem -Path "HSPrint.Installer/bin/Release" -Filter "*.msi" -Recurse | Select-Object -First 1
        if ($msi) {
          New-Item -ItemType Directory -Path "./artifacts" -Force
          Copy-Item $msi.FullName -Destination "./artifacts/HSPrintSetup-${{ steps.version.outputs.VERSION }}.msi"
          Write-Host "MSI created: ./artifacts/HSPrintSetup-${{ steps.version.outputs.VERSION }}.msi"
          
          # Show MSI details
          $msiFile = Get-Item "./artifacts/HSPrintSetup-${{ steps.version.outputs.VERSION }}.msi"
          Write-Host "MSI Size: $([math]::Round($msiFile.Length / 1MB, 2)) MB"
        } else {
          Write-Error "MSI file not found!"
          exit 1
        }

    - name: Copy install script
      shell: pwsh
      run: |
        Copy-Item install.ps1 -Destination ./artifacts/install.ps1

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: HSPrint-${{ steps.version.outputs.VERSION }}
        path: |
          ./artifacts/*.msi
          ./artifacts/install.ps1

    - name: Upload to Supabase Storage
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/')
      shell: pwsh
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $msiFile = "./artifacts/HSPrintSetup-$version.msi"
        
        if (Test-Path $msiFile) {
          $headers = @{
            "Authorization" = "Bearer $env:SUPABASE_SERVICE_ROLE_KEY"
            "Content-Type" = "application/x-msi"
          }
        
          $uploadUrl = "$env:SUPABASE_URL/storage/v1/object/hsprint-releases/HSPrintSetup-$version.msi"
        
          try {
            Invoke-RestMethod -Uri $uploadUrl -Method POST -Headers $headers -InFile $msiFile
            Write-Host "Successfully uploaded HSPrintSetup-$version.msi to Supabase Storage"
          } catch {
            Write-Host "Warning: Failed to upload to Supabase: $_"
          }
        }

    - name: Create Git Tag
      shell: pwsh
      run: |
        $version = "${{ steps.version.outputs.VERSION }}"
        $tag = "v$version"
        
        # Check if tag exists
        git fetch --tags
        $existingTag = git tag -l $tag
        
        if (-not $existingTag) {
          git tag $tag
          git push origin $tag
          Write-Host "Created and pushed tag: $tag"
        } else {
          Write-Host "Tag $tag already exists"
        }

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: HSPrint v${{ steps.version.outputs.VERSION }}
        draft: false
        prerelease: false
        generate_release_notes: true
        files: |
          ./artifacts/HSPrintSetup-${{ steps.version.outputs.VERSION }}.msi
          ./artifacts/install.ps1
        body: |
          ## HSPrint v${{ steps.version.outputs.VERSION }}
          
          ### What's New
          - ‚ú® **GUI Configuration Tool** with system tray support
          - üéõÔ∏è Service control (Start/Stop) from the configuration window
          - üìä Real-time log viewer
          - ‚öôÔ∏è Startup configuration toggle
          - üîÑ Direct link to check for updates on GitHub
          - üîî System tray notifications for service status
          
          ### Installation
          
          **MSI Installer (Recommended)**
          1. Download `HSPrintSetup-${{ steps.version.outputs.VERSION }}.msi`
          2. Run the installer (double-click or use the PowerShell script)
          3. HSPrint service will automatically start and run on Windows startup
          4. Configuration tool will appear in system tray
          
          **PowerShell Installation**
          1. Download both `HSPrintSetup-${{ steps.version.outputs.VERSION }}.msi` and `install.ps1`
          2. Run PowerShell as Administrator
          3. Execute: `.\install.ps1 -MsiPath "HSPrintSetup-${{ steps.version.outputs.VERSION }}.msi"`
          
          ### Features
          - ‚úÖ Windows Service with automatic startup
          - ‚úÖ GUI Configuration Tool with system tray icon
          - ‚úÖ Service control (start/stop) from GUI
          - ‚úÖ Real-time log viewer
          - ‚úÖ ZPL, Image, and PDF printing support
          - ‚úÖ Local API on http://localhost:50246
          - ‚úÖ Swagger documentation at http://localhost:50246/swagger
          
          ### Upgrade Notes
          The installer will automatically:
          - Stop running HSPrint instances
          - Uninstall previous versions
          - Clear cache to ensure clean installation
          - Configure Windows startup
          - Launch the configuration tool
          
          ### System Requirements
          - Windows 10/11 or Windows Server 2016+
          - Administrator rights for installation
          
          For more information, see the [README](https://github.com/${{ github.repository }}/blob/main/README.md)
